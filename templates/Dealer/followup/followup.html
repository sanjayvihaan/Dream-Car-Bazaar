{% extends 'Dealer/account/layout.html' %}
{% load static %}

{% block common_css %}
<style>
    .edit-icon, .save-icon {
        cursor: pointer;
        color: blue;
    }
    .delete-icon {
        cursor: pointer;
        color: red;
    }
    .hidden {
        display: none;
    }
/* Highlight style */
.highlight {
        background-color: yellow;
    }          
</style>
<style>
    /* In your CSS file or <style> block */
.future-record {
    background-color: #f8d7da;  /* Light red background for past dates */
    color: #721c24;  /* Dark red text for past dates */
}

.past-record {
    background-color: #d4edda;  /* Light green background for future dates */
    color: #155724;  /* Dark green text for future dates */
}

/* Optional styling to make the entire row stand out */
.record {
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 5px;
}

.dynamicDropdown {
    border: 1px solid black !important;
}

.card {
    border: none;
}

.tab_container {
    background-color: rgba(10, 35, 87, .9);
    padding: 20px;
    border-radius: 8px;
}

.nav-pills>li>a, .nav-tabs>li>a{
    color: #fff;
    font-family: 'Inter', sans-serif;
}

.nav-pills .nav-link.active, .nav-pills .show>.nav-link {
    background-color: #fff;
    color: #1A3760;
    
}

.download_btn {
    background-color: rgba(245, 195, 75, .9);
}

.action-container {
    position: relative;
    display: inline-block;
}
.action-buttons {
    display: none;
    flex-direction: row;
    gap: 5px;
    background-color: white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    padding: 5px;
    border-radius: 4px;
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
}

.notes-section {
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
}
.add-note textarea {
    width: 100%;
    height: 80px;
    border: 1px solid #ccc;
    padding: 8px;
    border-radius: 5px;
}
.notes-list .note-item {
    background: #fff;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 5px;
    box-shadow: 0px 1px 3px rgba(0, 0, 0, 0.1);
}
.note-meta {
    font-size: 12px;
    color: #666;
}

:root {
    --primary-color: #4361ee;
    --secondary-color: #3f37c9;
    --light-color: #f8f9fa;
    --dark-color: #495057;
    --success-color: #4caf50;
    --danger-color: #f44336;
    --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    --transition: all 0.3s ease;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f5f7ff;
}

.lead-panel {
    width: 400px;
    height: 100vh;
    position: fixed;
    right: 0;
    top: 0;
    background-color: white;
    box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
    transition: var(--transition);
    z-index: 1050;
    overflow-y: auto;
}

.lead-header {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: 20px;
    position: sticky;
    top: 0;
    z-index: 10;
}

{% comment %} .lead-title {
    display: flex;
    align-items: center;
    justify-content: space-between;
} {% endcomment %}

.lead-body {
    padding: 0;
}

.close-btn {
    background: transparent;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
    transition: var(--transition);
}

.close-btn:hover {
    transform: scale(1.1);
}

.nav-tabs {
    border-bottom: none;
    background-color: #f1f3f9;
    padding: 5px 5px 0;
}

.nav-tabs .nav-link {
    border: none;
    color: var(--dark-color);
    font-weight: 500;
    border-radius: 8px 8px 0 0;
    padding: 10px 20px;
    transition: var(--transition);
}

.nav-tabs .nav-link.active {
    background-color: white;
    color: var(--primary-color);
    box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
    border-bottom: 2px solid var(--primary-color);
}

.tab-content {
    padding: 20px;
}

.info-card {
    background-color: white;
    border-radius: 10px;
    box-shadow: var(--card-shadow);
    margin-bottom: 20px;
    overflow: hidden;
}

.info-card-header {
    background-color: #f8f9fa;
    padding: 12px 20px;
    font-weight: 600;
    color: var(--dark-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #e9ecef;
}

.info-card-body {
    padding: 15px 20px;
}

.info-row {
    display: flex;
    margin-bottom: 10px;
    align-items: baseline;
}

.info-label {
    font-weight: 500;
    color: #6c757d;
    width: 120px;
    flex-shrink: 0;
}

.info-value {
    font-weight: 500;
    color: var(--dark-color);
    flex-grow: 1;
}

.badge-status {
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
}

.badge-cold {
    background-color: #e1f5fe;
    color: #0288d1;
}

.badge-live {
    background-color: #e8f5e9;
    color: #43a047;
}

.car-card {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    margin-bottom: 15px;
    transition: var(--transition);
}

.car-card:hover {
    box-shadow: var(--card-shadow);
    transform: translateY(-2px);
}

.car-header {
    padding: 12px 15px;
    background-color: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.car-body {
    padding: 15px;
}

.notes-textarea {
    width: 100%;
    border: 1px solid #ced4da;
    border-radius: 8px;
    padding: 10px;
    min-height: 100px;
    margin-bottom: 10px;
    resize: vertical;
}

.note-item {
    padding: 12px;
    border-radius: 8px;
    background-color: #f8f9fa;
    margin-bottom: 10px;
    border-left: 3px solid var(--primary-color);
}

.note-meta {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #6c757d;
    margin-top: 5px;
}

.activity-item {
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 10px;
    display: flex;
    align-items: flex-start;
    border-bottom: 1px dashed #e9ecef;
}

.activity-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-color: #e1f5fe;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    flex-shrink: 0;
}

.activity-content {
    flex-grow: 1;
}

.activity-time {
    font-size: 12px;
    color: #6c757d;
}

.btn-primary {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.btn-primary:hover {
    background-color: var(--secondary-color);
    border-color: var(--secondary-color);
}

.btn-outline-primary {
    color: var(--primary-color);
    border-color: var(--primary-color);
}

.btn-outline-primary:hover {
    background-color: var(--primary-color);
    color: white;
}

.contact-action {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-color: #f1f3f9;
    color: var(--primary-color);
    margin-right: 10px;
    transition: var(--transition);
}

.contact-action:hover {
    background-color: var(--primary-color);
    color: white;
    transform: scale(1.05);
}

.quick-actions {
    display: flex;
    justify-content: space-around;
    margin: 20px 0;
}

.price-tag {
    font-weight: bold;
    color: var(--primary-color);
    font-size: 18px;
}

.status-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 6px;
}

.status-live {
    background-color: var(--success-color);
}

.status-cold {
    background-color: #90a4ae;
}

@media only screen and (max-width: 600px) {
    .offcanvas {
        width: 100% !important;
    }
    .tab-content{
        padding: 0;
    }
}

.notes_action_icons {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 10px;
}

</style>

{% endblock %}

{% block body %}
<div class="container-fluid">
     <div class="row mb-4">
        <div class="">
            <div class="d-flex justify-content-between">
                <div class="page-title-box">
                    <h2 class="mb-sm-0">All Leads</h2>
                </div>

                <div class="d-flex justify-content-end align-items-center gap-30px">
                    <div class="m-2">
                        <form method="GET" action="{% url 'dealer:follow_up' %}">
                            {% comment %} <label for="carFilter">Search Cars:</label> {% endcomment %}
                           {% comment %} <select class="dropdown" id="carFilter" name="car_name" onchange="filterTable()">
                                <option value="all" {% if selected_car == 'all' or not selected_car %}selected{% endif %}>All Cars</option>
                                {% for car in cars %}
                                    <option value="{{ car.full_name }}"
                                        {% if selected_car == car.full_name %}selected{% endif %}>
                                        {{ car.full_name }}
                                    </option>
                                {% endfor %}
                            </select> {% endcomment %}
                            <div class="dropdown">
                                <button class="btn btn-[#fff] dropdown-toggle dynamicDropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="dropdownMenuButton">
                                  {% if selected_car and selected_car != 'all' %}
                                    {{ selected_car }}
                                  {% else %}
                                    All Cars
                                  {% endif %}
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                  <li>
                                    <a class="dropdown-item" href="#" onclick="selectCar('all')">All Cars</a>
                                  </li>
                                  {% for car in cars %}
                                    <li>
                                      <a class="dropdown-item" href="#" onclick="selectCar('{{ car.full_name }}')">{{ car.full_name }}</a>
                                    </li>
                                  {% endfor %}
                                </ul>
                              </div>
                              
                              <input type="hidden" id="carFilter" name="car_name" value="{{ selected_car }}" />
                              
                        </form>
                    </div>
                    <div class="m-2">
                        <div class="text-sm-end">
                            <div class="btn-group">
                                <button type="button" class="btn color-[#1A3760] download_btn waves-effect waves-light dropdown-toggle"
                                        data-bs-toggle="dropdown" aria-expanded="false" id="selectdownload" >
                                    <i class="fa fa-download me-1"></i>  Download
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end" >
                                    <!-- PDF Option -->
                                    <li>
                                        <a class="dropdown-item" href="#" id="downloadSelectedPdf">Download as PDF</a>
                                    </li>
                                    <!-- Excel Option -->
                                    <li>
                                        <a class="dropdown-item" href="{% url 'dealer:download_lead_excel' %}" id="downloadSelectedExcel">Download as Excel</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        {% comment %} <div class="row mb-2">
            <div class="col-sm-4">
                <div class="search-box me-2 mb-2 d-inline-block">
                    <div class="position-relative">
                        <input type="text" class="form-control" id="searchInput" onkeyup="searchTable()" placeholder="Search...">
                        <i class="bx bx-search-alt search-icon"></i>
                    </div>
                </div>
            </div> {% endcomment %}
        
        <div class="row">
            <div class="col-12 tab_container">
                <div class="tab_card">
                    <div class="card-body">
                        <ul class="nav nav-pills nav-justified" role="tablist">
                            <!-- All Leads Tab -->
                            <li class="nav-item waves-effect waves-light" role="presentation">
                                <a class="nav-link {% if selected_status == 'all' %}active{% endif %}" 
                                   data-bs-toggle="tab" href="#all-leads" role="tab" aria-selected="{% if selected_status == 'all' %}true{% else %}false{% endif %}">
                                    <span class="d-block d-sm-none"><i class="fas fa-users"></i></span>
                                    <span class="d-none d-sm-block">All Leads</span>
                                </a>
                            </li>
                            <li class="nav-item waves-effect waves-light" role="presentation">
                                <a class="nav-link" data-bs-toggle="tab" href="#cold-leads" role="tab" aria-selected="true">
                                    <span class="d-block d-sm-none"><i class="fas fa-snowflake"></i></span>
                                    <span class="d-none d-sm-block">Cold Leads</span>
                                </a>
                            </li>
                            <li class="nav-item waves-effect waves-light " role="presentation">
                                <a class="nav-link" data-bs-toggle="tab" href="#warm-leads" role="tab" aria-selected="false" tabindex="-1">
                                    <span class="d-block d-sm-none"><i class="fas fa-home"></i></span>
                                    <span class="d-none d-sm-block">Warm Leads </span>
                                </a>
                            </li>
                            <li class="nav-item waves-effect waves-light " role="presentation">
                                <a class="nav-link" data-bs-toggle="tab" href="#hot-leads" role="tab" aria-selected="false" tabindex="-1">
                                    <span class="d-block d-sm-none"><i class="fas fa-fire"></i></span>
                                    <span class="d-none d-sm-block">Hot Leads</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        

        
        </div>
        <div class="row">
            <div class="col-12">

                <div class="card">
                    <div class="card-body p-2">
                        <!-- Tab panes -->
                        <div class="tab-content text-muted">
                            {% comment %} <input type="text" id="searchBox" placeholder="Search..." class="form-control" style="margin-bottom: 10px;"> {% endcomment %}
                            <!-- Side Panel (Bootstrap Offcanvas) -->
                            <div class="offcanvas offcanvas-end" tabindex="-1" id="userDetailsPanel" style="width: 44%">
                                <div class="offcanvas-header bg-primary text-white">
                                    <div class="lead-title">
                                        {% comment %} <h5 class="offcanvas-title">Lead Details</h5> {% endcomment %}
                                        <h5 id="userDetailsPanelLabel">User Details</h5>
                                        <div class="d-flex mt-3" id="contactActions">
                                            <!-- Contact actions will be dynamically added here -->
                                        </div>
                                    </div>
                                    <div class="">
                                        <button type="button" class="btn-close text-white" data-bs-dismiss="offcanvas"></button>
                                    </div>
                                </div>
                                <div class="offcanvas-body">
                                    <ul class="nav nav-tabs" id="leadTabs">
                                        <li class="nav-item">
                                            <a class="nav-link active" data-bs-toggle="tab" href="#overviewTab">
                                                <i class="fas fa-info-circle me-1"></i> Overview
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" data-bs-toggle="tab" href="#carsTab">
                                                <i class="fas fa-car me-1"></i> Interested Cars
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" data-bs-toggle="tab" href="#notesTab" id="notes_tab">
                                                <i class="fas fa-sticky-note me-1"></i> Notes
                                            </a>
                                        </li>
                                    </ul>
                                    <div class="tab-content mt-3">
                                        <!-- Overview Tab -->
                                        <div class="tab-pane fade show active" id="overviewTab">
                                            {% comment %} <div class="quick-actions">
                                                <button class="btn btn-primary">
                                                    <i class="fas fa-calendar-plus me-1"></i> Schedule
                                                </button>
                                                <button class="btn btn-outline-primary">
                                                    <i class="fas fa-tasks me-1"></i> Add Task
                                                </button>
                                                <button class="btn btn-outline-primary">
                                                    <i class="fas fa-file-alt me-1"></i> Documents
                                                </button>
                                            </div> {% endcomment %}
                                            <div class="info-card">
                                                <div class="info-card-header">
                                                    <span>Contact Information</span>
                                                    {% comment %} <button class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-pen"></i>
                                                    </button> {% endcomment %}
                                                </div>
                                                <div class="info-card-body" id="contactInfo">
                                                    <!-- Contact information will be dynamically added here -->
                                                </div>
                                            </div>
                                            <div class="info-card">
                                                <div class="info-card-header">
                                                    <span>Lead Status</span>
                                                    {% comment %} <button class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-pen"></i>
                                                    </button> {% endcomment %}
                                                </div>
                                                <div class="info-card-body" id="leadStatus">
                                                    <!-- Lead status will be dynamically added here -->
                                                </div>
                                            </div>
                                            <div class="info-card">
                                                <div class="info-card-header">
                                                    <span>Primary Interest</span>
                                                    <span class="badge badge-status badge-live">
                                                        <i class="fas fa-circle status-live me-1"></i> Live
                                                    </span>
                                                </div>
                                                <div class="info-card-body" id="primaryInterest">
                                                    <!-- Primary interest will be dynamically added here -->
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Interested Cars Tab -->
                                        <div class="tab-pane fade" id="carsTab">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="mb-0">Interested Vehicles</h6>
                                            </div>
                                            <div id="userCarList">
                                                <!-- Interested cars will be dynamically added here -->
                                            </div>
                                        </div>
                                        <!-- Notes Tab -->
                                        <div class="tab-pane fade" id="notesTab">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="mb-0">Sales Notes</h6>
                                            </div>
                                            <div class="notes-section" data-lead-id="{{ lead.id }}">
                                                <div class="add-note">
                                                    <textarea id="salesNotes" class="notes-textarea" placeholder="Add a new note..."></textarea>
                                                    <div class="d-grid">
                                                        <button class="btn btn-primary" id="save_notes" onclick="save_notes()">
                                                            <i class="fas fa-plus me-1"></i> Add Note
                                                        </button>
                                                        <button class="btn btn-primary" id="edit_notes" style="display: none;">
                                                            <i class="fas fa-plus me-1"></i> Edit Note
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="notes-list mt-3">
                                                    <h6>Previous Notes</h6>
                                                    <div id="notesContainer">
                                                        <!-- Notes will be dynamically added here -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane fade show active" id="all-leads" role="tabpanel">
                                <div class="card">
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <div id="myGrid" class="ag-theme-alpine" style="height: 500px; width: 100%;"></div>

                                            
                                        </div>
                                    </div>
                                 </div>
                                </div>

                                <script>
                                    var notesArray = []
                                    document.addEventListener("DOMContentLoaded", function () {
                                        console.log("Initializing AG Grid...");
                                    
                                        var rowData = [
                                            {% for lead in all_leads %}
                                            {
                                                id: `{{ lead.id }}`,
                                                user: `{{ lead.user.get_full_name }}`,
                                                phone: `{{ lead.user.phone }}`,
                                                email: `{{ lead.user.email }}`,
                                                userType: `{{ lead.user_type }}`,
                                                visitTime: `{{ lead.visit_time }}`,
                                                engagement: `{{ lead.page_stay_duration }}`,
                                                status: `{{ lead.status }}`,
                                                visitCount: `{{ lead.visit_count }}`,
                                                interest: `{{ lead.viewed_car.variant.model.brand.name }} {{ lead.viewed_car.variant.model.name }} {{ lead.viewed_car.variant.name }}`,
                                                interestedCars: [
                                                    {
                                                        car_id: `{{ lead.viewed_car.id }}`,
                                                        car_name: `{{ lead.viewed_car.variant.model.brand.name }} {{ lead.viewed_car.variant.model.name }} {{ lead.viewed_car.variant.name }}`,
                                                        registration_no: `{{ lead.viewed_car.registration_no }}`,
                                                        updated_at: `{{ lead.viewed_car.updated_at.date }}`,
                                                        demand_price: `{{ lead.viewed_car.demand_price }}`,
                                                        status: `{{ lead.viewed_car.status }}`,
                                                        images: [{% for img in car.image_urls %}"{{ img }}"{% if not forloop.last %}, {% endif %}{% endfor %}]

                                                    }
                                                ]
                                            },
                                            {% endfor %}
                                        ];

                                    


                                        console.log("Row Data:", );


                                        
                                        
                                    
                                    
                                        // Add responsive styles
                                        const mobileStyles = document.createElement('style');
                                        mobileStyles.textContent = `
                                            @media (max-width: 768px) {
                                                .ag-root-wrapper {
                                                    overflow-x: auto !important;
                                                    white-space: nowrap;
                                                }
                                                .ag-header-cell-text {
                                                    font-size: 14px;
                                                }
                                                .btn-sm {
                                                    padding: 6px 10px !important;
                                                    font-size: 12px;
                                                }
                                            }
                                        `;
                                        document.head.appendChild(mobileStyles);
                                    
                                        var gridOptions = {
                                            columnDefs: [
                                                { headerName: "User", field: "user", sortable: true, filter: true, minWidth: 150,
                                                cellRenderer: function (params) {
                                                    if (!params.data) return "";
                                                    
                                                    let link = document.createElement("a");
                                                    link.href = "#";
                                                    link.textContent = params.value;
                                                    link.style.color = "#0a2357e6";
                                                    link.style.fontSize = "14px";
                                                    link.style.fontWeight = "700";
                                                    link.style.cursor = "pointer";
                                                    
                                                    link.addEventListener("click", function () {
                                                        openUserPanel(params.data);
                                                    });
                                                    
                                                    return link;
                                                }
                                            
                                                },
                                                { headerName: "Phone", field: "phone", sortable: true, filter: true, minWidth: 120 },
                                                { headerName: "Email", field: "email", sortable: true, filter: true, minWidth: 180 },
                                                { headerName: "User Type", field: "userType", sortable: true, filter: true, minWidth: 120 },
                                                { headerName: "Visited At", field: "visitTime", sortable: true, filter: true, minWidth: 230 },
                                                { headerName: "Engagement (s)", field: "engagement", sortable: true, filter: true, minWidth: 140 },
                                                { headerName: "Status", field: "status", sortable: true, filter: true, minWidth: 100 },
                                                { headerName: "Interest", field: "interest", sortable: true, filter: true, minWidth: 200 },
                                                { headerName: "Visit Count", field: "visitCount", sortable: true, filter: true, minWidth: 100 },
                                                //pinned: 'right',
                                                { 
                                                    headerName: "Actions",
                                                    field: "actions",
                                                    minWidth: 150,
                                                    cellRenderer: function (params) {
                                                        if (!params.data) return "";
                                    
                                                        const container = document.createElement("div");
                                                        container.classList.add("d-flex", "gap-2");
                                    
                                                        if (params.data.phone) {
                                                            let callBtn = document.createElement("a");
                                                            callBtn.href = `tel:${params.data.phone}`;
                                                            callBtn.classList.add("btn", "btn-sm", "btn-primary");
                                                            callBtn.innerHTML = "📞";
                                                            container.appendChild(callBtn);
                                    
                                                            let smsBtn = document.createElement("a");
                                                            smsBtn.href = `sms:${params.data.phone}`;
                                                            smsBtn.classList.add("btn", "btn-sm", "btn-success");
                                                            smsBtn.innerHTML = "✉️";
                                                            container.appendChild(smsBtn);
                                                        }
                                    
                                                        if (params.data.email) {
                                                            let emailBtn = document.createElement("a");
                                                            emailBtn.href = `mailto:${params.data.email}`;
                                                            emailBtn.classList.add("btn", "btn-sm", "btn-info");
                                                            emailBtn.innerHTML = "📧";
                                                            container.appendChild(emailBtn);
                                                        }

                                                        // Share Button
                                                        let shareBtn = document.createElement("button");
                                                        shareBtn.classList.add("btn", "btn-sm", "btn-warning");
                                                        shareBtn.innerHTML = "📤";

                                                        shareBtn.onclick = function () {
                                                            const carLink = `https://www.dreamcarbazaar.com/car_detail/${params.data.interestedCars[0]?.car_id || "N/A"}`;
                                                            const leadDetails = `Lead Details:
                                                            Name: ${params.data.user || "N/A"}
                                                            Phone: ${params.data.phone || "N/A"}
                                                            Email: ${params.data.email || "N/A"}
                                                            Status: ${params.data.status || "N/A"}
                                                            Car Name: ${params.data.interestedCars[0]?.car_name || "N/A"}
                                                            Registration No.: ${params.data.interestedCars[0]?.registration_no || "N/A"}
                                                            Date: ${params.data.interestedCars[0]?.updated_at || "N/A"}
                                                            Price: ${params.data.interestedCars[0]?.demand_price || "N/A"}
                                                            Click Here: ${carLink}
                                                            `;
                                                    

                                                            if (navigator.share) {
                                                                navigator.share({
                                                                    title: "Lead Information",
                                                                    text: leadDetails,
                                                                }).catch((error) => console.error("Sharing failed:", error));
                                                            } else {
                                                                // Fallback: Copy to clipboard
                                                                navigator.clipboard.writeText(leadDetails).then(() => {
                                                                    alert("Lead details copied to clipboard!");
                                                                });
                                                            }
                                                        };

                                                        container.appendChild(shareBtn);

                                    
                                                        return container;
                                                    }
                                                }
                                            ],
                                            pagination: true,
                                            paginationPageSize: 10,
                                            domLayout: 'autoHeight',
                                            defaultColDef: { 
                                                flex: 1, 
                                                resizable: true,
                                                wrapText: true,
                                                autoHeight: true,
                                            },
                                            autoSizeStrategy: {
                                                type: 'fitCellContents'
                                            },                                        
                                            tooltipShowDelay: 0,
                                            enableCellTextSelection: true,
                                            suppressMenuHide: true,
                                            onGridReady: function (params) {
                                                console.log("AG Grid is ready!");
                                                params.api.setRowData(rowData);
                                    
                                                // Auto-size all columns for content
                                                setTimeout(() => {
                                                    let allColumnIds = [];
                                                    params.columnApi.getAllColumns().forEach((column) => {
                                                        allColumnIds.push(column.getId());
                                                    });
                                                    params.columnApi.autoSizeColumns(allColumnIds);
                                                }, 100);
                                                
                                                // Handle resize for better mobile responsiveness
                                                window.addEventListener('resize', function() {
                                                    clearTimeout(window.resizeTimer);
                                                    window.resizeTimer = setTimeout(() => {
                                                        params.columnApi.autoSizeColumns(allColumnIds);
                                                    }, 250);
                                                });
                                            }
                                        };
                                    
                                        var eGridDiv = document.querySelector("#myGrid");
                                        agGrid.createGrid(eGridDiv, gridOptions);


                                        function openUserPanel(data) {
                                            getNotes(data.id, "fetch-all", null, null)
                                            current_lead_id = data.id
                                            // Clear previous content
                                            document.getElementById("userCarList").innerHTML = "";
                                            document.getElementById("contactActions").innerHTML = "";
                                            document.getElementById("contactInfo").innerHTML = "";
                                            document.getElementById("leadStatus").innerHTML = "";
                                            document.getElementById("primaryInterest").innerHTML = "";
                                        
                                            // Set the lead details in the panel header
                                            document.getElementById("userDetailsPanelLabel").textContent = `Lead Details - ${data.user}`;

                                        
                                            // Add contact actions
                                            const contactActionsHtml = `
                                                <a href="tel:${data.phone}" class="contact-action" title="Call">
                                                    <i class="fas fa-phone-alt"></i>
                                                </a>
                                                <a href="mailto:${data.email}" class="contact-action" title="Email">
                                                    <i class="fas fa-envelope"></i>
                                                </a>
                                                <a href="sms:${data.phone}" class="contact-action" title="SMS">
                                                    <i class="fas fa-comment-alt"></i>
                                                </a>
                                                <a href="https://wa.me/${data.phone}" class="contact-action" title="WhatsApp">
                                                    <i class="fab fa-whatsapp"></i>
                                                </a>
                                            `;
                                            document.getElementById("contactActions").innerHTML = contactActionsHtml;
                                        
                                            // Add contact information
                                            const contactInfoHtml = `
                                                <div class="info-row">
                                                    <div class="info-label">Name:</div>
                                                    <div class="info-value">${data.user}</div>
                                                </div>
                                                <div class="info-row">
                                                    <div class="info-label">Phone:</div>
                                                    <div class="info-value">${data.phone}</div>
                                                </div>
                                                <div class="info-row">
                                                    <div class="info-label">Email:</div>
                                                    <div class="info-value">${data.email}</div>
                                                </div>
                                                <div class="info-row">
                                                    <div class="info-label">User Type:</div>
                                                    <div class="info-value">${data.userType}</div>
                                                </div>
                                            `;
                                            document.getElementById("contactInfo").innerHTML = contactInfoHtml;
                                        
                                            // Add lead status
                                            const leadStatusHtml = `
                                                <div class="info-row">
                                                    <div class="info-label">Status:</div>
                                                    <div class="info-value">
                                                        <span class="badge badge-status badge-cold">
                                                            <i class="fas fa-thermometer-empty me-1"></i> ${data.status}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="info-row">
                                                    <div class="info-label">Visit Date:</div>
                                                    <div class="info-value">${data.visitTime}</div>
                                                </div>
                                                <div class="info-row">
                                                    <div class="info-label">Engagement:</div>
                                                    <div class="info-value">${data.engagement} seconds</div>
                                                </div>
                                                <div class="info-row">
                                                    <div class="info-label">Visit Count:</div>
                                                    <div class="info-value">${data.visitCount}</div>
                                                </div>
                                            `;
                                            document.getElementById("leadStatus").innerHTML = leadStatusHtml;
                                        
                                            // Add primary interest
                                            const primaryInterestHtml = `
                                                <h6>${data.interest}</h6>
                                                <div class="info-row">
                                                    <div class="info-label">Price:</div>
                                                    <div class="info-value price-tag">₹ ${data.interestedCars[0].demand_price}</div>
                                                </div>
                                                <div class="info-row">
                                                    <div class="info-label">Reg No:</div>
                                                    <div class="info-value">${data.interestedCars[0].registration_no}</div>
                                                </div>
                                                <div class="d-grid gap-2 mt-3">
                                                    <a href="/dealer/car_detail/${data.interestedCars[0].car_id}" class="btn btn-primary">
                                                        <i class="fas fa-eye me-1"></i> View Details
                                                    </a>
                                                </div>
                                            `;
                                            document.getElementById("primaryInterest").innerHTML = primaryInterestHtml;
                                        
                                            // Display interested cars
                                            if (data.interestedCars && data.interestedCars.length > 0) {
                                                data.interestedCars.forEach((car, index) => {
                                                    let carItem = document.createElement("div");
                                                    carItem.classList.add("card", "mb-3", "shadow-sm");
                                                    let carouselId = `carCarousel_${index}`;
                                        
                                                    let carouselHtml = `
                                                        <div id="${carouselId}" class="carousel slide" data-bs-ride="carousel">
                                                            <div class="carousel-inner">
                                                                ${car.images.map((img, idx) => `
                                                                    <div class="carousel-item ${idx === 0 ? 'active' : ''}">
                                                                        <img src="${img}" class="d-block w-100 rounded" alt="Car Image">
                                                                    </div>
                                                                `).join('')}
                                                            </div>
                                                            <button class="carousel-control-prev" type="button" data-bs-target="#${carouselId}" data-bs-slide="prev">
                                                                <span class="carousel-control-prev-icon"></span>
                                                            </button>
                                                            <button class="carousel-control-next" type="button" data-bs-target="#${carouselId}" data-bs-slide="next">
                                                                <span class="carousel-control-next-icon"></span>
                                                            </button>
                                                        </div>
                                                    `;
                                        
                                                    carItem.innerHTML = `
                                                        <div class="card-header d-flex justify-content-between">
                                                            <h6 class="mb-0">${car.car_name}</h6>
                                                            <button class="btn btn-sm btn-light" data-bs-toggle="collapse" data-bs-target="#carDetails_${index}">
                                                                <i class="fas fa-chevron-down"></i>
                                                            </button>
                                                        </div>
                                                        <div id="carDetails_${index}" class="collapse show">
                                                            <div class="card-body">
                                                                ${carouselHtml}
                                                                <p><strong>Reg No:</strong> ${car.registration_no}</p>
                                                                <p><strong>Updated:</strong> ${car.updated_at}</p>
                                                                <p><strong>Price:</strong> ${car.demand_price}</p>
                                                                <p><strong>Status:</strong> <span class="badge ${getBadgeClass(car.status)}">${car.status}</span></p>
                                                                <a href="/dealer/car_detail/${car.car_id}" class="btn btn-primary btn-sm w-100">View</a>
                                                            </div>
                                                        </div>
                                                    `;
                                                    document.getElementById("userCarList").appendChild(carItem);
                                                });
                                            } else {
                                                document.getElementById("userCarList").innerHTML = "<p class='text-muted'>No interested cars found.</p>";
                                            }
                                        
                                            // Load previous notes if available
                                            //loadNotes(data.id);

                                            // Show the side panel
                                            var userPanel = new bootstrap.Offcanvas(document.getElementById("userDetailsPanel"));
                                            userPanel.show();
                                        }
                                        
                                        function getBadgeClass(status) {
                                            switch (status) {
                                                case "live": return "badge-soft-success";
                                                case "expired": return "badge-soft-danger";
                                                case "sold": return "badge-soft-warning";
                                                default: return "badge-soft-secondary";
                                            }
                                        }
                                    });

                                    document.addEventListener("DOMContentLoaded", function () {
                                        var current_lead_id = "";
                                        function saveNotes() {
                                            const noteText = document.getElementById('salesNotes').value;
                                            if (noteText.trim() === '') return;
                                    
                                            const noteItem = document.createElement('div');
                                            noteItem.classList.add('note-item');
                                            noteItem.innerHTML = `
                                                <p>${noteText}</p>
                                                <small class="note-meta">Added on: ${new Date().toLocaleDateString()}</small>
                                            `;
                                    
                                            document.getElementById('notesContainer').prepend(noteItem);
                                            document.getElementById('salesNotes').value = '';
                                        }
                                        
                                    
                                        function loadNotes() {
                                            let userDetailsPanel = document.getElementById("userDetailsPanel");
                                        
                                            if (!userDetailsPanel) {
                                                console.error("❌ userDetailsPanel not found!");
                                                return;
                                            }
                                        
                                            let leadId = userDetailsPanel.dataset.leadId;
                                            console.log("📌 Lead ID found:", leadId);  // Debugging
                                        
                                            if (leadId) {
                                                let savedNotes = localStorage.getItem(`leadNotes_${leadId}`);
                                                document.getElementById("salesNotes").value = savedNotes ? savedNotes : "";
                                            } else {
                                                console.error("❌ Lead ID is missing in dataset!");
                                            }
                                        }
                                        
                                    
                                        // Make functions available globally
                                        window.saveNotes = saveNotes;
                                        window.loadNotes = loadNotes;
                                    
                                        // Load notes automatically when the page loads
                                        //loadNotes();
                                    });
                                    
                                    
                                    
                                    

                                    
                                    
                                    
                            
                                </script>
                                
                            
                            <div class="tab-pane fade" id="cold-leads" role="tabpanel">
                                <div class="card">
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <div id="coldLeadsGrid" class="ag-theme-alpine" style="height: 500px; width: 100%;"></div>
                                        </div>
                                    </div>
                                 </div>

                                 <script>
                                    document.addEventListener("DOMContentLoaded", function () {
                                        console.log("Initializing AG Grid...");
                                    
                                        var rowData = [
                                            {% for lead in cold_leads %}
                                            {
                                                id: `{{ lead.id }}`,
                                                user: `{{ lead.user.get_full_name }}`,
                                                phone: `{{ lead.user.phone }}`,
                                                email: `{{ lead.user.email }}`,
                                                userType: `{{ lead.user_type }}`,
                                                visitTime: `{{ lead.visit_time }}`,
                                                engagement: `{{ lead.page_stay_duration }}`,
                                                status: `{{ lead.status }}`,
                                                visitCount: `{{ lead.visit_count }}`,
                                                interest: `{{ lead.viewed_car.variant.model.brand.name }} {{ lead.viewed_car.variant.model.name }} {{ lead.viewed_car.variant.name }}`,
                                                interestedCars: [
                                                    {
                                                        car_id: `{{ lead.viewed_car.id }}`,
                                                        car_name: `{{ lead.viewed_car.variant.model.brand.name }} {{ lead.viewed_car.variant.model.name }} {{ lead.viewed_car.variant.name }}`,
                                                        registration_no: `{{ lead.viewed_car.registration_no }}`,
                                                        updated_at: `{{ lead.viewed_car.updated_at.date }}`,
                                                        demand_price: `{{ lead.viewed_car.demand_price }}`,
                                                        status: `{{ lead.viewed_car.status }}`,
                                                        images: [{% for img in car.image_urls %}"{{ img }}"{% if not forloop.last %}, {% endif %}{% endfor %}]

                                                    }
                                                ]
                                            },
                                            {% endfor %}
                                        ];

                                    


                                        console.log("Row Data:", );


                                        
                                        
                                    
                                    
                                        // Add responsive styles
                                        const mobileStyles = document.createElement('style');
                                        mobileStyles.textContent = `
                                            @media (max-width: 768px) {
                                                .ag-root-wrapper {
                                                    overflow-x: auto !important;
                                                    white-space: nowrap;
                                                }
                                                .ag-header-cell-text {
                                                    font-size: 14px;
                                                }
                                                .btn-sm {
                                                    padding: 6px 10px !important;
                                                    font-size: 12px;
                                                }
                                            }
                                        `;
                                        document.head.appendChild(mobileStyles);
                                    
                                        var gridOptions = {
                                            columnDefs: [
                                                { headerName: "User", field: "user", sortable: true, filter: true, minWidth: 150,
                                                cellRenderer: function (params) {
                                                    if (!params.data) return "";
                                                    
                                                    let link = document.createElement("a");
                                                    link.href = "#";
                                                    link.textContent = params.value;
                                                    link.style.color = "#0a2357e6";
                                                    link.style.fontSize = "14px";
                                                    link.style.fontWeight = "700";
                                                    link.style.cursor = "pointer";
                                                    
                                                    link.addEventListener("click", function () {
                                                        openUserPanel(params.data);
                                                    });
                                                    
                                                    return link;
                                                }
                                            
                                                },
                                                { headerName: "Phone", field: "phone", sortable: true, filter: true, minWidth: 120 },
                                                { headerName: "Email", field: "email", sortable: true, filter: true, minWidth: 180 },
                                                { headerName: "User Type", field: "userType", sortable: true, filter: true, minWidth: 120 },
                                                { headerName: "Visited At", field: "visitTime", sortable: true, filter: true, minWidth: 230 },
                                                { headerName: "Engagement (s)", field: "engagement", sortable: true, filter: true, minWidth: 140 },
                                                { headerName: "Status", field: "status", sortable: true, filter: true, minWidth: 100 },
                                                { headerName: "Interest", field: "interest", sortable: true, filter: true, minWidth: 230 },
                                                { headerName: "Visit Count", field: "visitCount", sortable: true, filter: true, minWidth: 100 },
                                                //pinned: 'right',
                                                { 
                                                    headerName: "Actions",
                                                    field: "actions",
                                                    minWidth: 180,
                                                    cellRenderer: function (params) {
                                                        if (!params.data) return "";
                                    
                                                        const container = document.createElement("div");
                                                        container.classList.add("d-flex", "gap-2");
                                    
                                                        if (params.data.phone) {
                                                            let callBtn = document.createElement("a");
                                                            callBtn.href = `tel:${params.data.phone}`;
                                                            callBtn.classList.add("btn", "btn-sm", "btn-primary");
                                                            callBtn.innerHTML = "📞";
                                                            container.appendChild(callBtn);
                                    
                                                            let smsBtn = document.createElement("a");
                                                            smsBtn.href = `sms:${params.data.phone}`;
                                                            smsBtn.classList.add("btn", "btn-sm", "btn-success");
                                                            smsBtn.innerHTML = "✉️";
                                                            container.appendChild(smsBtn);
                                                        }
                                    
                                                        if (params.data.email) {
                                                            let emailBtn = document.createElement("a");
                                                            emailBtn.href = `mailto:${params.data.email}`;
                                                            emailBtn.classList.add("btn", "btn-sm", "btn-info");
                                                            emailBtn.innerHTML = "📧";
                                                            container.appendChild(emailBtn);
                                                        }

                                                        // Share Button
                                                        let shareBtn = document.createElement("button");
                                                        shareBtn.classList.add("btn", "btn-sm", "btn-warning");
                                                        shareBtn.innerHTML = "📤";

                                                        shareBtn.onclick = function () {
                                                            const carLink = `https://www.dreamcarbazaar.com/car_detail/${params.data.interestedCars[0]?.car_id || "N/A"}`;
                                                            const leadDetails = `Lead Details:
                                                            Name: ${params.data.user || "N/A"}
                                                            Phone: ${params.data.phone || "N/A"}
                                                            Email: ${params.data.email || "N/A"}
                                                            Status: ${params.data.status || "N/A"}
                                                            Car Name: ${params.data.interestedCars[0]?.car_name || "N/A"}
                                                            Registration No.: ${params.data.interestedCars[0]?.registration_no || "N/A"}
                                                            Date: ${params.data.interestedCars[0]?.updated_at || "N/A"}
                                                            Price: ${params.data.interestedCars[0]?.demand_price || "N/A"}
                                                            Click Here: ${carLink}
                                                            `;
                                                    

                                                            if (navigator.share) {
                                                                navigator.share({
                                                                    title: "Lead Information",
                                                                    text: leadDetails,
                                                                }).catch((error) => console.error("Sharing failed:", error));
                                                            } else {
                                                                // Fallback: Copy to clipboard
                                                                navigator.clipboard.writeText(leadDetails).then(() => {
                                                                    alert("Lead details copied to clipboard!");
                                                                });
                                                            }
                                                        };

                                                        container.appendChild(shareBtn);

                                    
                                                        return container;
                                                    }
                                                }
                                            ],
                                            pagination: true,
                                            paginationPageSize: 10,
                                            domLayout: 'autoHeight',
                                            defaultColDef: { 
                                                flex: 1, 
                                                resizable: true,
                                                wrapText: true,
                                                autoHeight: true,
                                            },
                                            autoSizeStrategy: {
                                                type: 'fitCellContents'
                                            },                                        
                                            tooltipShowDelay: 0,
                                            enableCellTextSelection: true,
                                            suppressMenuHide: true,
                                            onGridReady: function (params) {
                                                console.log("AG Grid is ready!");
                                                params.api.setRowData(rowData);
                                    
                                                // Auto-size all columns for content
                                                setTimeout(() => {
                                                    let allColumnIds = [];
                                                    params.columnApi.getAllColumns().forEach((column) => {
                                                        allColumnIds.push(column.getId());
                                                    });
                                                    params.columnApi.autoSizeColumns(allColumnIds);
                                                }, 100);
                                                
                                                // Handle resize for better mobile responsiveness
                                                window.addEventListener('resize', function() {
                                                    clearTimeout(window.resizeTimer);
                                                    window.resizeTimer = setTimeout(() => {
                                                        params.columnApi.autoSizeColumns(allColumnIds);
                                                    }, 250);
                                                });
                                            }
                                        };
                                    
                                        var eGridDiv = document.querySelector("#coldLeadsGrid");
                                        agGrid.createGrid(eGridDiv, gridOptions);


                                        function openUserPanel(data) {
                                            getNotes(data.id, "fetch-all", null, null)
                                            current_lead_id = data.id
                                            console.log("Opening user panel for:", data); // Debugging
                                            current_lead_id = data.id
                                            console.log('current_lead_id: ', current_lead_id)
                                        
                                            // Clear previous content
                                            document.getElementById("userCarList").innerHTML = "";
                                            document.getElementById("contactActions").innerHTML = "";
                                            document.getElementById("contactInfo").innerHTML = "";
                                            document.getElementById("leadStatus").innerHTML = "";
                                            document.getElementById("primaryInterest").innerHTML = "";
                                        
                                            // Set the lead details in the panel header
                                            document.getElementById("userDetailsPanelLabel").textContent = `Lead Details - ${data.user}`;
                                        
                                            // Add contact actions
                                            const contactActionsHtml = `
                                                <a href="tel:${data.phone}" class="contact-action" title="Call">
                                                    <i class="fas fa-phone-alt"></i>
                                                </a>
                                                <a href="mailto:${data.email}" class="contact-action" title="Email">
                                                    <i class="fas fa-envelope"></i>
                                                </a>
                                                <a href="sms:${data.phone}" class="contact-action" title="SMS">
                                                    <i class="fas fa-comment-alt"></i>
                                                </a>
                                                <a href="https://wa.me/${data.phone}" class="contact-action" title="WhatsApp">
                                                    <i class="fab fa-whatsapp"></i>
                                                </a>
                                            `;
                                            document.getElementById("contactActions").innerHTML = contactActionsHtml;
                                        
                                            // Add contact information
                                            const contactInfoHtml = `
                                                <div class="info-row">
                                                    <div class="info-label">Name:</div>
                                                    <div class="info-value">${data.user}</div>
                                                </div>
                                                <div class="info-row">
                                                    <div class="info-label">Phone:</div>
                                                    <div class="info-value">${data.phone}</div>
                                                </div>
                                                <div class="info-row">
                                                    <div class="info-label">Email:</div>
                                                    <div class="info-value">${data.email}</div>
                                                </div>
                                                <div class="info-row">
                                                    <div class="info-label">User Type:</div>
                                                    <div class="info-value">${data.userType}</div>
                                                </div>
                                            `;
                                            document.getElementById("contactInfo").innerHTML = contactInfoHtml;
                                        
                                            // Add lead status
                                            const leadStatusHtml = `
                                                <div class="info-row">
                                                    <div class="info-label">Status:</div>
                                                    <div class="info-value">
                                                        <span class="badge badge-status badge-cold">
                                                            <i class="fas fa-thermometer-empty me-1"></i> ${data.status}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="info-row">
                                                    <div class="info-label">Visit Date:</div>
                                                    <div class="info-value">${data.visitTime}</div>
                                                </div>
                                                <div class="info-row">
                                                    <div class="info-label">Engagement:</div>
                                                    <div class="info-value">${data.engagement} seconds</div>
                                                </div>
                                                <div class="info-row">
                                                    <div class="info-label">Visit Count:</div>
                                                    <div class="info-value">${data.visitCount}</div>
                                                </div>
                                            `;
                                            document.getElementById("leadStatus").innerHTML = leadStatusHtml;
                                        
                                            // Add primary interest
                                            const primaryInterestHtml = `
                                                <h6>${data.interest}</h6>
                                                <div class="info-row">
                                                    <div class="info-label">Price:</div>
                                                    <div class="info-value price-tag">₹ ${data.interestedCars[0].demand_price}</div>
                                                </div>
                                                <div class="info-row">
                                                    <div class="info-label">Reg No:</div>
                                                    <div class="info-value">${data.interestedCars[0].registration_no}</div>
                                                </div>
                                                <div class="d-grid gap-2 mt-3">
                                                    <a href="/dealer/car_detail/${data.interestedCars[0].car_id}" class="btn btn-primary">
                                                        <i class="fas fa-eye me-1"></i> View Details
                                                    </a>
                                                </div>
                                            `;
                                            document.getElementById("primaryInterest").innerHTML = primaryInterestHtml;
                                        
                                            // Display interested cars
                                            if (data.interestedCars && data.interestedCars.length > 0) {
                                                data.interestedCars.forEach((car, index) => {
                                                    let carItem = document.createElement("div");
                                                    carItem.classList.add("card", "mb-3", "shadow-sm");
                                                    let carouselId = `carCarousel_${index}`;
                                        
                                                    let carouselHtml = `
                                                        <div id="${carouselId}" class="carousel slide" data-bs-ride="carousel">
                                                            <div class="carousel-inner">
                                                                ${car.images.map((img, idx) => `
                                                                    <div class="carousel-item ${idx === 0 ? 'active' : ''}">
                                                                        <img src="${img}" class="d-block w-100 rounded" alt="Car Image">
                                                                    </div>
                                                                `).join('')}
                                                            </div>
                                                            <button class="carousel-control-prev" type="button" data-bs-target="#${carouselId}" data-bs-slide="prev">
                                                                <span class="carousel-control-prev-icon"></span>
                                                            </button>
                                                            <button class="carousel-control-next" type="button" data-bs-target="#${carouselId}" data-bs-slide="next">
                                                                <span class="carousel-control-next-icon"></span>
                                                            </button>
                                                        </div>
                                                    `;
                                        
                                                    carItem.innerHTML = `
                                                        <div class="card-header d-flex justify-content-between">
                                                            <h6 class="mb-0">${car.car_name}</h6>
                                                            <button class="btn btn-sm btn-light" data-bs-toggle="collapse" data-bs-target="#carDetails_${index}">
                                                                <i class="fas fa-chevron-down"></i>
                                                            </button>
                                                        </div>
                                                        <div id="carDetails_${index}" class="collapse show">
                                                            <div class="card-body">
                                                                ${carouselHtml}
                                                                <p><strong>Reg No:</strong> ${car.registration_no}</p>
                                                                <p><strong>Updated:</strong> ${car.updated_at}</p>
                                                                <p><strong>Price:</strong> ${car.demand_price}</p>
                                                                <p><strong>Status:</strong> <span class="badge ${getBadgeClass(car.status)}">${car.status}</span></p>
                                                                <a href="/dealer/car_detail/${car.car_id}" class="btn btn-primary btn-sm w-100">View</a>
                                                            </div>
                                                        </div>
                                                    `;
                                                    document.getElementById("userCarList").appendChild(carItem);
                                                });
                                            } else {
                                                document.getElementById("userCarList").innerHTML = "<p class='text-muted'>No interested cars found.</p>";
                                            }
                                        
                                            // Load previous notes if available
                                            loadNotes(data.id);
                                        
                                            // Show the side panel
                                            var userPanel = new bootstrap.Offcanvas(document.getElementById("userDetailsPanel"));
                                            userPanel.show();
                                        }
                                        /*function openUserPanel(leadData) {
                                            let userDetailsPanel = document.getElementById("userDetailsPanel");
                                            
                                            if (!userDetailsPanel) {
                                                console.error("userDetailsPanel not found here");
                                                return;
                                            }
                                        
                                            if (!leadData || !leadData.id) {
                                                console.error("Lead Data is missing or invalid: ", leadData);
                                                return;
                                            }
                                        
                                            userDetailsPanel.dataset.leadId = leadData.id;
                                            console.log("Lead Data set:", leadData);
                                        
                                            // Check and set Lead ID Display
                                            let leadIdDisplay = document.getElementById("leadIdDisplay");
                                            if (leadIdDisplay) {
                                                leadIdDisplay.textContent = leadData.id;
                                            } else {
                                                console.error("leadIdDisplay element not found!");
                                            }
                                        
                                            // Check and set Sales Notes
                                            let salesNotes = document.getElementById("salesNotes");
                                            if (salesNotes) {
                                                salesNotes.value = "";  // Clear previous notes
                                            } else {
                                                console.error("salesNotes element not found!");
                                            }
                                        
                                            // Check and populate interested cars
                                            let carListContainer = document.getElementById("userCarList");
                                            if (!carListContainer) {
                                                console.error("userCarList element not found!");
                                                return;
                                            }
                                            carListContainer.innerHTML = ""; // Clear previous cars
                                        
                                            if (leadData.interestedCars && leadData.interestedCars.length > 0) {
                                                leadData.interestedCars.forEach((car, index) => {
                                                    let carItem = document.createElement("div");
                                                    carItem.classList.add("card", "mb-3", "shadow-sm");
                                        
                                                    let carouselId = `carCarousel_${index}`;
                                                    let carouselHtml = `
                                                        <div id="${carouselId}" class="carousel slide" data-bs-ride="carousel">
                                                            <div class="carousel-inner">
                                                                ${car.images.map((img, idx) => `
                                                                    <div class="carousel-item ${idx === 0 ? 'active' : ''}">
                                                                        <img src="${img}" class="d-block w-100 rounded" alt="Car Image">
                                                                    </div>
                                                                `).join('')}
                                                            </div>
                                                            <button class="carousel-control-prev" type="button" data-bs-target="#${carouselId}" data-bs-slide="prev">
                                                                <span class="carousel-control-prev-icon"></span>
                                                            </button>
                                                            <button class="carousel-control-next" type="button" data-bs-target="#${carouselId}" data-bs-slide="next">
                                                                <span class="carousel-control-next-icon"></span>
                                                            </button>
                                                        </div>
                                                    `;
                                        
                                                    carItem.innerHTML = `
                                                        <div class="card-header d-flex justify-content-between">
                                                            <h6 class="mb-0">${car.car_name}</h6>
                                                            <button class="btn btn-sm btn-light" data-bs-toggle="collapse" data-bs-target="#carDetails_${index}">
                                                                <i class="fas fa-chevron-down"></i>
                                                            </button>
                                                        </div>
                                                        <div id="carDetails_${index}" class="collapse show">
                                                            <div class="card-body">
                                                                ${carouselHtml}
                                                                <p><strong>Reg No:</strong> ${car.registration_no}</p>
                                                                <p><strong>Updated:</strong> ${car.updated_at}</p>
                                                                <p><strong>Price:</strong> ${car.demand_price}</p>
                                                                <p><strong>Status:</strong> <span class="badge ${getBadgeClass(car.status)}">${car.status}</span></p>
                                                                <a href="/dealer/car_detail/${car.car_id}" class="btn btn-primary btn-sm w-100">View</a>
                                                            </div>
                                                        </div>
                                                    `;
                                                    carListContainer.appendChild(carItem);
                                                });
                                            } else {
                                                carListContainer.innerHTML = "<p class='text-muted'>No interested cars found.</p>";
                                            }
                                        
                                            //loadNotes(leadData.id);
                                        
                                            let userPanel = new bootstrap.Offcanvas(userDetailsPanel);
                                            userPanel.show();
                                        }*/
                                        
                                        
                                           
                                        
                                        function getBadgeClass(status) {
                                            switch (status) {
                                                case "live": return "badge-soft-success";
                                                case "expired": return "badge-soft-danger";
                                                case "sold": return "badge-soft-warning";
                                                default: return "badge-soft-secondary";
                                            }
                                        }

                                        
                                        
                                        
                                        

                                    });

                                    document.addEventListener("DOMContentLoaded", function () {
                                        function saveNotes() {
                                            const noteText = document.getElementById('salesNotes').value;
                                            if (noteText.trim() === '') return;
                                    
                                            const noteItem = document.createElement('div');
                                            noteItem.classList.add('note-item');
                                            noteItem.innerHTML = `
                                                <p>${noteText}</p>
                                                <small class="note-meta">Added on: ${new Date().toLocaleDateString()}</small>
                                            `;
                                    
                                            document.getElementById('notesContainer').prepend(noteItem);
                                            document.getElementById('salesNotes').value = '';
                                        }
                                        
                                    
                                        function loadNotes() {
                                            let userDetailsPanel = document.getElementById("userDetailsPanel");
                                        
                                            if (!userDetailsPanel) {
                                                console.error("❌ userDetailsPanel not found!");
                                                return;
                                            }
                                        
                                            let leadId = userDetailsPanel.dataset.leadId;
                                            console.log("📌 Lead ID found:", leadId);  // Debugging
                                        
                                            if (leadId) {
                                                let savedNotes = localStorage.getItem(`leadNotes_${leadId}`);
                                                document.getElementById("salesNotes").value = savedNotes ? savedNotes : "";
                                            } else {
                                                console.error("❌ Lead ID is missing in dataset!");
                                            }
                                        }
                                        
                                    
                                        // Make functions available globally
                                        window.saveNotes = saveNotes;
                                        window.loadNotes = loadNotes;
                                    
                                        // Load notes automatically when the page loads
                                        //loadNotes();
                                    });

                                 </script>
                                
                                

                                 
                            
                        </div>
                        <div class="tab-pane fade" role="tabpanel " id="warm-leads">
                            <div class="card ">
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <div id="warmLeads" class="ag-theme-alpine" style="height: 500px; width: 100%;"></div>

                                        <script>
                                            document.addEventListener("DOMContentLoaded", function () {
                                                console.log("Initializing AG Grid...");
                                            
                                                var rowData = [
                                                    {% for lead in warm_leads %}
                                                    {
                                                        id: `{{ lead.id }}`,
                                                        user: `{{ lead.user.get_full_name }}`,
                                                        phone: `{{ lead.user.phone }}`,
                                                        email: `{{ lead.user.email }}`,
                                                        userType: `{{ lead.user_type }}`,
                                                        visitTime: `{{ lead.visit_time }}`,
                                                        engagement: `{{ lead.page_stay_duration }}`,
                                                        status: `{{ lead.status }}`,
                                                        visitCount: `{{ lead.visit_count }}`,
                                                        interest: `{{ lead.viewed_car.variant.model.brand.name }} {{ lead.viewed_car.variant.model.name }} {{ lead.viewed_car.variant.name }}`,
                                                        interestedCars: [
                                                            {
                                                                car_id: `{{ lead.viewed_car.id }}`,
                                                                car_name: `{{ lead.viewed_car.variant.model.brand.name }} {{ lead.viewed_car.variant.model.name }} {{ lead.viewed_car.variant.name }}`,
                                                                registration_no: `{{ lead.viewed_car.registration_no }}`,
                                                                updated_at: `{{ lead.viewed_car.updated_at.date }}`,
                                                                demand_price: `{{ lead.viewed_car.demand_price }}`,
                                                                status: `{{ lead.viewed_car.status }}`,
                                                                images: [{% for img in car.image_urls %}"{{ img }}"{% if not forloop.last %}, {% endif %}{% endfor %}]
        
                                                            }
                                                        ]
                                                    },
                                                    {% endfor %}
                                                ];
        
                                            
        
        
                                                console.log("Row Data:", );
        
        
                                                
                                                
                                            
                                            
                                                // Add responsive styles
                                                const mobileStyles = document.createElement('style');
                                                mobileStyles.textContent = `
                                                    @media (max-width: 768px) {
                                                        .ag-root-wrapper {
                                                            overflow-x: auto !important;
                                                            white-space: nowrap;
                                                        }
                                                        .ag-header-cell-text {
                                                            font-size: 14px;
                                                        }
                                                        .btn-sm {
                                                            padding: 6px 10px !important;
                                                            font-size: 12px;
                                                        }
                                                    }
                                                `;
                                                document.head.appendChild(mobileStyles);
                                            
                                                var gridOptions = {
                                                    columnDefs: [
                                                        { headerName: "User", field: "user", sortable: true, filter: true, minWidth: 150,
                                                        cellRenderer: function (params) {
                                                            if (!params.data) return "";
                                                            
                                                            let link = document.createElement("a");
                                                            link.href = "#";
                                                            link.textContent = params.value;
                                                            link.style.color = "#0a2357e6";
                                                            link.style.fontSize = "14px";
                                                            link.style.fontWeight = "700";
                                                            link.style.cursor = "pointer";
                                                            
                                                            link.addEventListener("click", function () {
                                                                openUserPanel(params.data);
                                                            });
                                                            
                                                            return link;
                                                        }
                                                    
                                                        },
                                                        { headerName: "Phone", field: "phone", sortable: true, filter: true, minWidth: 120 },
                                                        { headerName: "Email", field: "email", sortable: true, filter: true, minWidth: 180 },
                                                        { headerName: "User Type", field: "userType", sortable: true, filter: true, minWidth: 120 },
                                                        { headerName: "Visited At", field: "visitTime", sortable: true, filter: true, minWidth: 230 },
                                                        { headerName: "Engagement (s)", field: "engagement", sortable: true, filter: true, minWidth: 140 },
                                                        { headerName: "Status", field: "status", sortable: true, filter: true, minWidth: 100 },
                                                        { headerName: "Interest", field: "interest", sortable: true, filter: true, minWidth: 230 },
                                                        { headerName: "Visit Count", field: "visitCount", sortable: true, filter: true, minWidth: 100 },
                                                        //pinned: 'right',
                                                        { 
                                                            headerName: "Actions",
                                                            field: "actions",
                                                            minWidth: 180,
                                                            cellRenderer: function (params) {
                                                                if (!params.data) return "";
                                            
                                                                const container = document.createElement("div");
                                                                container.classList.add("d-flex", "gap-2");
                                            
                                                                if (params.data.phone) {
                                                                    let callBtn = document.createElement("a");
                                                                    callBtn.href = `tel:${params.data.phone}`;
                                                                    callBtn.classList.add("btn", "btn-sm", "btn-primary");
                                                                    callBtn.innerHTML = "📞";
                                                                    container.appendChild(callBtn);
                                            
                                                                    let smsBtn = document.createElement("a");
                                                                    smsBtn.href = `sms:${params.data.phone}`;
                                                                    smsBtn.classList.add("btn", "btn-sm", "btn-success");
                                                                    smsBtn.innerHTML = "✉️";
                                                                    container.appendChild(smsBtn);
                                                                }
                                            
                                                                if (params.data.email) {
                                                                    let emailBtn = document.createElement("a");
                                                                    emailBtn.href = `mailto:${params.data.email}`;
                                                                    emailBtn.classList.add("btn", "btn-sm", "btn-info");
                                                                    emailBtn.innerHTML = "📧";
                                                                    container.appendChild(emailBtn);
                                                                }
        
                                                                // Share Button
                                                                let shareBtn = document.createElement("button");
                                                                shareBtn.classList.add("btn", "btn-sm", "btn-warning");
                                                                shareBtn.innerHTML = "📤";
        
                                                                shareBtn.onclick = function () {
                                                                    const carLink = `https://www.dreamcarbazaar.com/car_detail/${params.data.interestedCars[0]?.car_id || "N/A"}`;
                                                                    const leadDetails = `Lead Details:
                                                                    Name: ${params.data.user || "N/A"}
                                                                    Phone: ${params.data.phone || "N/A"}
                                                                    Email: ${params.data.email || "N/A"}
                                                                    Status: ${params.data.status || "N/A"}
                                                                    Car Name: ${params.data.interestedCars[0]?.car_name || "N/A"}
                                                                    Registration No.: ${params.data.interestedCars[0]?.registration_no || "N/A"}
                                                                    Date: ${params.data.interestedCars[0]?.updated_at || "N/A"}
                                                                    Price: ${params.data.interestedCars[0]?.demand_price || "N/A"}
                                                                    Click Here: ${carLink}
                                                                    `;
                                                            
        
                                                                    if (navigator.share) {
                                                                        navigator.share({
                                                                            title: "Lead Information",
                                                                            text: leadDetails,
                                                                        }).catch((error) => console.error("Sharing failed:", error));
                                                                    } else {
                                                                        // Fallback: Copy to clipboard
                                                                        navigator.clipboard.writeText(leadDetails).then(() => {
                                                                            alert("Lead details copied to clipboard!");
                                                                        });
                                                                    }
                                                                };
        
                                                                container.appendChild(shareBtn);
        
                                            
                                                                return container;
                                                            }
                                                        }
                                                    ],
                                                    pagination: true,
                                                    paginationPageSize: 10,
                                                    domLayout: 'autoHeight',
                                                    defaultColDef: { 
                                                        flex: 1, 
                                                        resizable: true,
                                                        wrapText: true,
                                                        autoHeight: true,
                                                    },
                                                    autoSizeStrategy: {
                                                        type: 'fitCellContents'
                                                    },                                        
                                                    tooltipShowDelay: 0,
                                                    enableCellTextSelection: true,
                                                    suppressMenuHide: true,
                                                    onGridReady: function (params) {
                                                        console.log("AG Grid is ready!");
                                                        params.api.setRowData(rowData);
                                            
                                                        // Auto-size all columns for content
                                                        setTimeout(() => {
                                                            let allColumnIds = [];
                                                            params.columnApi.getAllColumns().forEach((column) => {
                                                                allColumnIds.push(column.getId());
                                                            });
                                                            params.columnApi.autoSizeColumns(allColumnIds);
                                                        }, 100);
                                                        
                                                        // Handle resize for better mobile responsiveness
                                                        window.addEventListener('resize', function() {
                                                            clearTimeout(window.resizeTimer);
                                                            window.resizeTimer = setTimeout(() => {
                                                                params.columnApi.autoSizeColumns(allColumnIds);
                                                            }, 250);
                                                        });
                                                    }
                                                };
                                            
                                                var eGridDiv = document.querySelector("#warmLeads");
                                                agGrid.createGrid(eGridDiv, gridOptions);
        
        
                                                function openUserPanel(data) {
                                                    getNotes(data.id, "fetch-all", null, null)
                                                    current_lead_id = data.id
                                                    console.log("Opening user panel for:", data); // Debugging
                                                
                                                    // Clear previous content
                                                    document.getElementById("userCarList").innerHTML = "";
                                                    document.getElementById("contactActions").innerHTML = "";
                                                    document.getElementById("contactInfo").innerHTML = "";
                                                    document.getElementById("leadStatus").innerHTML = "";
                                                    document.getElementById("primaryInterest").innerHTML = "";
                                                
                                                    // Set the lead details in the panel header
                                                    document.getElementById("userDetailsPanelLabel").textContent = `Lead Details - ${data.user}`;
                                                
                                                    // Add contact actions
                                                    const contactActionsHtml = `
                                                        <a href="tel:${data.phone}" class="contact-action" title="Call">
                                                            <i class="fas fa-phone-alt"></i>
                                                        </a>
                                                        <a href="mailto:${data.email}" class="contact-action" title="Email">
                                                            <i class="fas fa-envelope"></i>
                                                        </a>
                                                        <a href="sms:${data.phone}" class="contact-action" title="SMS">
                                                            <i class="fas fa-comment-alt"></i>
                                                        </a>
                                                        <a href="https://wa.me/${data.phone}" class="contact-action" title="WhatsApp">
                                                            <i class="fab fa-whatsapp"></i>
                                                        </a>
                                                    `;
                                                    document.getElementById("contactActions").innerHTML = contactActionsHtml;
                                                
                                                    // Add contact information
                                                    const contactInfoHtml = `
                                                        <div class="info-row">
                                                            <div class="info-label">Name:</div>
                                                            <div class="info-value">${data.user}</div>
                                                        </div>
                                                        <div class="info-row">
                                                            <div class="info-label">Phone:</div>
                                                            <div class="info-value">${data.phone}</div>
                                                        </div>
                                                        <div class="info-row">
                                                            <div class="info-label">Email:</div>
                                                            <div class="info-value">${data.email}</div>
                                                        </div>
                                                        <div class="info-row">
                                                            <div class="info-label">User Type:</div>
                                                            <div class="info-value">${data.userType}</div>
                                                        </div>
                                                    `;
                                                    document.getElementById("contactInfo").innerHTML = contactInfoHtml;
                                                
                                                    // Add lead status
                                                    const leadStatusHtml = `
                                                        <div class="info-row">
                                                            <div class="info-label">Status:</div>
                                                            <div class="info-value">
                                                                <span class="badge badge-status badge-cold">
                                                                    <i class="fas fa-thermometer-empty me-1"></i> ${data.status}
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <div class="info-row">
                                                            <div class="info-label">Visit Date:</div>
                                                            <div class="info-value">${data.visitTime}</div>
                                                        </div>
                                                        <div class="info-row">
                                                            <div class="info-label">Engagement:</div>
                                                            <div class="info-value">${data.engagement} seconds</div>
                                                        </div>
                                                        <div class="info-row">
                                                            <div class="info-label">Visit Count:</div>
                                                            <div class="info-value">${data.visitCount}</div>
                                                        </div>
                                                    `;
                                                    document.getElementById("leadStatus").innerHTML = leadStatusHtml;
                                                
                                                    // Add primary interest
                                                    const primaryInterestHtml = `
                                                        <h6>${data.interest}</h6>
                                                        <div class="info-row">
                                                            <div class="info-label">Price:</div>
                                                            <div class="info-value price-tag">₹ ${data.interestedCars[0].demand_price}</div>
                                                        </div>
                                                        <div class="info-row">
                                                            <div class="info-label">Reg No:</div>
                                                            <div class="info-value">${data.interestedCars[0].registration_no}</div>
                                                        </div>
                                                        <div class="d-grid gap-2 mt-3">
                                                            <a href="/dealer/car_detail/${data.interestedCars[0].car_id}" class="btn btn-primary">
                                                                <i class="fas fa-eye me-1"></i> View Details
                                                            </a>
                                                        </div>
                                                    `;
                                                    document.getElementById("primaryInterest").innerHTML = primaryInterestHtml;
                                                
                                                    // Display interested cars
                                                    if (data.interestedCars && data.interestedCars.length > 0) {
                                                        data.interestedCars.forEach((car, index) => {
                                                            let carItem = document.createElement("div");
                                                            carItem.classList.add("card", "mb-3", "shadow-sm");
                                                            let carouselId = `carCarousel_${index}`;
                                                
                                                            let carouselHtml = `
                                                                <div id="${carouselId}" class="carousel slide" data-bs-ride="carousel">
                                                                    <div class="carousel-inner">
                                                                        ${car.images.map((img, idx) => `
                                                                            <div class="carousel-item ${idx === 0 ? 'active' : ''}">
                                                                                <img src="${img}" class="d-block w-100 rounded" alt="Car Image">
                                                                            </div>
                                                                        `).join('')}
                                                                    </div>
                                                                    <button class="carousel-control-prev" type="button" data-bs-target="#${carouselId}" data-bs-slide="prev">
                                                                        <span class="carousel-control-prev-icon"></span>
                                                                    </button>
                                                                    <button class="carousel-control-next" type="button" data-bs-target="#${carouselId}" data-bs-slide="next">
                                                                        <span class="carousel-control-next-icon"></span>
                                                                    </button>
                                                                </div>
                                                            `;
                                                
                                                            carItem.innerHTML = `
                                                                <div class="card-header d-flex justify-content-between">
                                                                    <h6 class="mb-0">${car.car_name}</h6>
                                                                    <button class="btn btn-sm btn-light" data-bs-toggle="collapse" data-bs-target="#carDetails_${index}">
                                                                        <i class="fas fa-chevron-down"></i>
                                                                    </button>
                                                                </div>
                                                                <div id="carDetails_${index}" class="collapse show">
                                                                    <div class="card-body">
                                                                        ${carouselHtml}
                                                                        <p><strong>Reg No:</strong> ${car.registration_no}</p>
                                                                        <p><strong>Updated:</strong> ${car.updated_at}</p>
                                                                        <p><strong>Price:</strong> ${car.demand_price}</p>
                                                                        <p><strong>Status:</strong> <span class="badge ${getBadgeClass(car.status)}">${car.status}</span></p>
                                                                        <a href="/dealer/car_detail/${car.car_id}" class="btn btn-primary btn-sm w-100">View</a>
                                                                    </div>
                                                                </div>
                                                            `;
                                                            document.getElementById("userCarList").appendChild(carItem);
                                                        });
                                                    } else {
                                                        document.getElementById("userCarList").innerHTML = "<p class='text-muted'>No interested cars found.</p>";
                                                    }
                                                
                                                    // Load previous notes if available
                                                    loadNotes(data.id);
                                                
                                                    // Show the side panel
                                                    var userPanel = new bootstrap.Offcanvas(document.getElementById("userDetailsPanel"));
                                                    userPanel.show();
                                                }
                                                /*function openUserPanel(leadData) {
                                                    let userDetailsPanel = document.getElementById("userDetailsPanel");
                                                    
                                                    if (!userDetailsPanel) {
                                                        console.error("userDetailsPanel not found here");
                                                        return;
                                                    }
                                                
                                                    if (!leadData || !leadData.id) {
                                                        console.error("Lead Data is missing or invalid: ", leadData);
                                                        return;
                                                    }
                                                
                                                    userDetailsPanel.dataset.leadId = leadData.id;
                                                    console.log("Lead Data set:", leadData);
                                                
                                                    // Check and set Lead ID Display
                                                    let leadIdDisplay = document.getElementById("leadIdDisplay");
                                                    if (leadIdDisplay) {
                                                        leadIdDisplay.textContent = leadData.id;
                                                    } else {
                                                        console.error("leadIdDisplay element not found!");
                                                    }
                                                
                                                    // Check and set Sales Notes
                                                    let salesNotes = document.getElementById("salesNotes");
                                                    if (salesNotes) {
                                                        salesNotes.value = "";  // Clear previous notes
                                                    } else {
                                                        console.error("salesNotes element not found!");
                                                    }
                                                
                                                    // Check and populate interested cars
                                                    let carListContainer = document.getElementById("userCarList");
                                                    if (!carListContainer) {
                                                        console.error("userCarList element not found!");
                                                        return;
                                                    }
                                                    carListContainer.innerHTML = ""; // Clear previous cars
                                                
                                                    if (leadData.interestedCars && leadData.interestedCars.length > 0) {
                                                        leadData.interestedCars.forEach((car, index) => {
                                                            let carItem = document.createElement("div");
                                                            carItem.classList.add("card", "mb-3", "shadow-sm");
                                                
                                                            let carouselId = `carCarousel_${index}`;
                                                            let carouselHtml = `
                                                                <div id="${carouselId}" class="carousel slide" data-bs-ride="carousel">
                                                                    <div class="carousel-inner">
                                                                        ${car.images.map((img, idx) => `
                                                                            <div class="carousel-item ${idx === 0 ? 'active' : ''}">
                                                                                <img src="${img}" class="d-block w-100 rounded" alt="Car Image">
                                                                            </div>
                                                                        `).join('')}
                                                                    </div>
                                                                    <button class="carousel-control-prev" type="button" data-bs-target="#${carouselId}" data-bs-slide="prev">
                                                                        <span class="carousel-control-prev-icon"></span>
                                                                    </button>
                                                                    <button class="carousel-control-next" type="button" data-bs-target="#${carouselId}" data-bs-slide="next">
                                                                        <span class="carousel-control-next-icon"></span>
                                                                    </button>
                                                                </div>
                                                            `;
                                                
                                                            carItem.innerHTML = `
                                                                <div class="card-header d-flex justify-content-between">
                                                                    <h6 class="mb-0">${car.car_name}</h6>
                                                                    <button class="btn btn-sm btn-light" data-bs-toggle="collapse" data-bs-target="#carDetails_${index}">
                                                                        <i class="fas fa-chevron-down"></i>
                                                                    </button>
                                                                </div>
                                                                <div id="carDetails_${index}" class="collapse show">
                                                                    <div class="card-body">
                                                                        ${carouselHtml}
                                                                        <p><strong>Reg No:</strong> ${car.registration_no}</p>
                                                                        <p><strong>Updated:</strong> ${car.updated_at}</p>
                                                                        <p><strong>Price:</strong> ${car.demand_price}</p>
                                                                        <p><strong>Status:</strong> <span class="badge ${getBadgeClass(car.status)}">${car.status}</span></p>
                                                                        <a href="/dealer/car_detail/${car.car_id}" class="btn btn-primary btn-sm w-100">View</a>
                                                                    </div>
                                                                </div>
                                                            `;
                                                            carListContainer.appendChild(carItem);
                                                        });
                                                    } else {
                                                        carListContainer.innerHTML = "<p class='text-muted'>No interested cars found.</p>";
                                                    }
                                                
                                                    //loadNotes(leadData.id);
                                                
                                                    let userPanel = new bootstrap.Offcanvas(userDetailsPanel);
                                                    userPanel.show();
                                                }*/
                                                
                                                
                                                   
                                                
                                                function getBadgeClass(status) {
                                                    switch (status) {
                                                        case "live": return "badge-soft-success";
                                                        case "expired": return "badge-soft-danger";
                                                        case "sold": return "badge-soft-warning";
                                                        default: return "badge-soft-secondary";
                                                    }
                                                }
        
                                                
                                                
                                                
                                                
        
                                            });
        
                                            document.addEventListener("DOMContentLoaded", function () {
                                                function saveNotes() {
                                                    const noteText = document.getElementById('salesNotes').value;
                                                    if (noteText.trim() === '') return;
                                            
                                                    const noteItem = document.createElement('div');
                                                    noteItem.classList.add('note-item');
                                                    noteItem.innerHTML = `
                                                        <p>${noteText}</p>
                                                        <small class="note-meta">Added on: ${new Date().toLocaleDateString()}</small>
                                                    `;
                                            
                                                    document.getElementById('notesContainer').prepend(noteItem);
                                                    document.getElementById('salesNotes').value = '';
                                                }
                                                
                                            
                                                function loadNotes() {
                                                    let userDetailsPanel = document.getElementById("userDetailsPanel");
                                                
                                                    if (!userDetailsPanel) {
                                                        console.error("❌ userDetailsPanel not found!");
                                                        return;
                                                    }
                                                
                                                    let leadId = userDetailsPanel.dataset.leadId;
                                                    console.log("📌 Lead ID found:", leadId);  // Debugging
                                                
                                                    if (leadId) {
                                                        let savedNotes = localStorage.getItem(`leadNotes_${leadId}`);
                                                        document.getElementById("salesNotes").value = savedNotes ? savedNotes : "";
                                                    } else {
                                                        console.error("❌ Lead ID is missing in dataset!");
                                                    }
                                                }
                                                
                                            
                                                // Make functions available globally
                                                window.saveNotes = saveNotes;
                                                window.loadNotes = loadNotes;
                                            
                                                // Load notes automatically when the page loads
                                                //loadNotes();
                                            });
        
                                         </script>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" role="tabpanel " id="hot-leads">
                            <div class="card ">
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <div id="hotLeads" class="ag-theme-alpine" style="height: 500px; width: 100%;"></div>
                                    </div>

                                    <script>
                                        document.addEventListener("DOMContentLoaded", function () {
                                            console.log("Initializing AG Grid...");
                                        
                                            var rowData = [
                                                {% for lead in hot_leads %}
                                                {
                                                    id: `{{ lead.id }}`,
                                                    user: `{{ lead.user.get_full_name }}`,
                                                    phone: `{{ lead.user.phone }}`,
                                                    email: `{{ lead.user.email }}`,
                                                    userType: `{{ lead.user_type }}`,
                                                    visitTime: `{{ lead.visit_time }}`,
                                                    engagement: `{{ lead.page_stay_duration }}`,
                                                    status: `{{ lead.status }}`,
                                                    visitCount: `{{ lead.visit_count }}`,
                                                    interest: `{{ lead.viewed_car.variant.model.brand.name }} {{ lead.viewed_car.variant.model.name }} {{ lead.viewed_car.variant.name }}`,
                                                    interestedCars: [
                                                        {
                                                            car_id: `{{ lead.viewed_car.id }}`,
                                                            car_name: `{{ lead.viewed_car.variant.model.brand.name }} {{ lead.viewed_car.variant.model.name }} {{ lead.viewed_car.variant.name }}`,
                                                            registration_no: `{{ lead.viewed_car.registration_no }}`,
                                                            updated_at: `{{ lead.viewed_car.updated_at.date }}`,
                                                            demand_price: `{{ lead.viewed_car.demand_price }}`,
                                                            status: `{{ lead.viewed_car.status }}`,
                                                            images: [{% for img in car.image_urls %}"{{ img }}"{% if not forloop.last %}, {% endif %}{% endfor %}]
    
                                                        }
                                                    ]
                                                },
                                                {% endfor %}
                                            ];
    
                                        
    
    
                                            console.log("Row Data:", );
    
    
                                            
                                            
                                        
                                        
                                            // Add responsive styles
                                            const mobileStyles = document.createElement('style');
                                            mobileStyles.textContent = `
                                                @media (max-width: 768px) {
                                                    .ag-root-wrapper {
                                                        overflow-x: auto !important;
                                                        white-space: nowrap;
                                                    }
                                                    .ag-header-cell-text {
                                                        font-size: 14px;
                                                    }
                                                    .btn-sm {
                                                        padding: 6px 10px !important;
                                                        font-size: 12px;
                                                    }
                                                }
                                            `;
                                            document.head.appendChild(mobileStyles);
                                        
                                            var gridOptions = {
                                                columnDefs: [
                                                    { headerName: "User", field: "user", sortable: true, filter: true, minWidth: 150,
                                                    cellRenderer: function (params) {
                                                        if (!params.data) return "";
                                                        
                                                        let link = document.createElement("a");
                                                        link.href = "#";
                                                        link.textContent = params.value;
                                                        link.style.color = "#0a2357e6";
                                                        link.style.fontSize = "14px";
                                                        link.style.fontWeight = "700";
                                                        link.style.cursor = "pointer";
                                                        
                                                        link.addEventListener("click", function () {
                                                            openUserPanel(params.data);
                                                        });
                                                        
                                                        return link;
                                                    }
                                                
                                                    },
                                                    { headerName: "Phone", field: "phone", sortable: true, filter: true, minWidth: 120 },
                                                    { headerName: "Email", field: "email", sortable: true, filter: true, minWidth: 180 },
                                                    { headerName: "User Type", field: "userType", sortable: true, filter: true, minWidth: 120 },
                                                    { headerName: "Visited At", field: "visitTime", sortable: true, filter: true, minWidth: 230 },
                                                    { headerName: "Engagement (s)", field: "engagement", sortable: true, filter: true, minWidth: 140 },
                                                    { headerName: "Status", field: "status", sortable: true, filter: true, minWidth: 100 },
                                                    { headerName: "Interest", field: "interest", sortable: true, filter: true, minWidth: 230 },
                                                    { headerName: "Visit Count", field: "visitCount", sortable: true, filter: true, minWidth: 100 },
                                                    //pinned: 'right',
                                                    { 
                                                        headerName: "Actions",
                                                        field: "actions",
                                                        minWidth: 180,
                                                        cellRenderer: function (params) {
                                                            if (!params.data) return "";
                                        
                                                            const container = document.createElement("div");
                                                            container.classList.add("d-flex", "gap-2");
                                        
                                                            if (params.data.phone) {
                                                                let callBtn = document.createElement("a");
                                                                callBtn.href = `tel:${params.data.phone}`;
                                                                callBtn.classList.add("btn", "btn-sm", "btn-primary");
                                                                callBtn.innerHTML = "📞";
                                                                container.appendChild(callBtn);
                                        
                                                                let smsBtn = document.createElement("a");
                                                                smsBtn.href = `sms:${params.data.phone}`;
                                                                smsBtn.classList.add("btn", "btn-sm", "btn-success");
                                                                smsBtn.innerHTML = "✉️";
                                                                container.appendChild(smsBtn);
                                                            }
                                        
                                                            if (params.data.email) {
                                                                let emailBtn = document.createElement("a");
                                                                emailBtn.href = `mailto:${params.data.email}`;
                                                                emailBtn.classList.add("btn", "btn-sm", "btn-info");
                                                                emailBtn.innerHTML = "📧";
                                                                container.appendChild(emailBtn);
                                                            }
    
                                                            // Share Button
                                                            let shareBtn = document.createElement("button");
                                                            shareBtn.classList.add("btn", "btn-sm", "btn-warning");
                                                            shareBtn.innerHTML = "📤";
    
                                                            shareBtn.onclick = function () {
                                                                const carLink = `https://www.dreamcarbazaar.com/car_detail/${params.data.interestedCars[0]?.car_id || "N/A"}`;
                                                                const leadDetails = `Lead Details:
                                                                Name: ${params.data.user || "N/A"}
                                                                Phone: ${params.data.phone || "N/A"}
                                                                Email: ${params.data.email || "N/A"}
                                                                Status: ${params.data.status || "N/A"}
                                                                Car Name: ${params.data.interestedCars[0]?.car_name || "N/A"}
                                                                Registration No.: ${params.data.interestedCars[0]?.registration_no || "N/A"}
                                                                Date: ${params.data.interestedCars[0]?.updated_at || "N/A"}
                                                                Price: ${params.data.interestedCars[0]?.demand_price || "N/A"}
                                                                Click Here: ${carLink}
                                                                `;
                                                        
    
                                                                if (navigator.share) {
                                                                    navigator.share({
                                                                        title: "Lead Information",
                                                                        text: leadDetails,
                                                                    }).catch((error) => console.error("Sharing failed:", error));
                                                                } else {
                                                                    // Fallback: Copy to clipboard
                                                                    navigator.clipboard.writeText(leadDetails).then(() => {
                                                                        alert("Lead details copied to clipboard!");
                                                                    });
                                                                }
                                                            };
    
                                                            container.appendChild(shareBtn);
    
                                        
                                                            return container;
                                                        }
                                                    }
                                                ],
                                                pagination: true,
                                                paginationPageSize: 10,
                                                domLayout: 'autoHeight',
                                                defaultColDef: { 
                                                    flex: 1, 
                                                    resizable: true,
                                                    wrapText: true,
                                                    autoHeight: true,
                                                },
                                                autoSizeStrategy: {
                                                    type: 'fitCellContents'
                                                },                                        
                                                tooltipShowDelay: 0,
                                                enableCellTextSelection: true,
                                                suppressMenuHide: true,
                                                onGridReady: function (params) {
                                                    console.log("AG Grid is ready!");
                                                    params.api.setRowData(rowData);
                                        
                                                    // Auto-size all columns for content
                                                    setTimeout(() => {
                                                        let allColumnIds = [];
                                                        params.columnApi.getAllColumns().forEach((column) => {
                                                            allColumnIds.push(column.getId());
                                                        });
                                                        params.columnApi.autoSizeColumns(allColumnIds);
                                                    }, 100);
                                                    
                                                    // Handle resize for better mobile responsiveness
                                                    window.addEventListener('resize', function() {
                                                        clearTimeout(window.resizeTimer);
                                                        window.resizeTimer = setTimeout(() => {
                                                            params.columnApi.autoSizeColumns(allColumnIds);
                                                        }, 250);
                                                    });
                                                }
                                            };
                                        
                                            var eGridDiv = document.querySelector("#hotLeads");
                                            agGrid.createGrid(eGridDiv, gridOptions);
    
    
                                            function openUserPanel(data) {
                                                getNotes(data.id, "fetch-all", null, null)
                                                current_lead_id = data.id
                                                console.log("Opening user panel for:", data); // Debugging
                                            
                                                // Clear previous content
                                                document.getElementById("userCarList").innerHTML = "";
                                                document.getElementById("contactActions").innerHTML = "";
                                                document.getElementById("contactInfo").innerHTML = "";
                                                document.getElementById("leadStatus").innerHTML = "";
                                                document.getElementById("primaryInterest").innerHTML = "";
                                            
                                                // Set the lead details in the panel header
                                                document.getElementById("userDetailsPanelLabel").textContent = `Lead Details - ${data.user}`;
                                            
                                                // Add contact actions
                                                const contactActionsHtml = `
                                                    <a href="tel:${data.phone}" class="contact-action" title="Call">
                                                        <i class="fas fa-phone-alt"></i>
                                                    </a>
                                                    <a href="mailto:${data.email}" class="contact-action" title="Email">
                                                        <i class="fas fa-envelope"></i>
                                                    </a>
                                                    <a href="sms:${data.phone}" class="contact-action" title="SMS">
                                                        <i class="fas fa-comment-alt"></i>
                                                    </a>
                                                    <a href="https://wa.me/${data.phone}" class="contact-action" title="WhatsApp">
                                                        <i class="fab fa-whatsapp"></i>
                                                    </a>
                                                `;
                                                document.getElementById("contactActions").innerHTML = contactActionsHtml;
                                            
                                                // Add contact information
                                                const contactInfoHtml = `
                                                    <div class="info-row">
                                                        <div class="info-label">Name:</div>
                                                        <div class="info-value">${data.user}</div>
                                                    </div>
                                                    <div class="info-row">
                                                        <div class="info-label">Phone:</div>
                                                        <div class="info-value">${data.phone}</div>
                                                    </div>
                                                    <div class="info-row">
                                                        <div class="info-label">Email:</div>
                                                        <div class="info-value">${data.email}</div>
                                                    </div>
                                                    <div class="info-row">
                                                        <div class="info-label">User Type:</div>
                                                        <div class="info-value">${data.userType}</div>
                                                    </div>
                                                `;
                                                document.getElementById("contactInfo").innerHTML = contactInfoHtml;
                                            
                                                // Add lead status
                                                const leadStatusHtml = `
                                                    <div class="info-row">
                                                        <div class="info-label">Status:</div>
                                                        <div class="info-value">
                                                            <span class="badge badge-status badge-cold">
                                                                <i class="fas fa-thermometer-empty me-1"></i> ${data.status}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div class="info-row">
                                                        <div class="info-label">Visit Date:</div>
                                                        <div class="info-value">${data.visitTime}</div>
                                                    </div>
                                                    <div class="info-row">
                                                        <div class="info-label">Engagement:</div>
                                                        <div class="info-value">${data.engagement} seconds</div>
                                                    </div>
                                                    <div class="info-row">
                                                        <div class="info-label">Visit Count:</div>
                                                        <div class="info-value">${data.visitCount}</div>
                                                    </div>
                                                `;
                                                document.getElementById("leadStatus").innerHTML = leadStatusHtml;
                                            
                                                // Add primary interest
                                                const primaryInterestHtml = `
                                                    <h6>${data.interest}</h6>
                                                    <div class="info-row">
                                                        <div class="info-label">Price:</div>
                                                        <div class="info-value price-tag">₹ ${data.interestedCars[0].demand_price}</div>
                                                    </div>
                                                    <div class="info-row">
                                                        <div class="info-label">Reg No:</div>
                                                        <div class="info-value">${data.interestedCars[0].registration_no}</div>
                                                    </div>
                                                    <div class="d-grid gap-2 mt-3">
                                                        <a href="/dealer/car_detail/${data.interestedCars[0].car_id}" class="btn btn-primary">
                                                            <i class="fas fa-eye me-1"></i> View Details
                                                        </a>
                                                    </div>
                                                `;
                                                document.getElementById("primaryInterest").innerHTML = primaryInterestHtml;
                                            
                                                // Display interested cars
                                                if (data.interestedCars && data.interestedCars.length > 0) {
                                                    data.interestedCars.forEach((car, index) => {
                                                        let carItem = document.createElement("div");
                                                        carItem.classList.add("card", "mb-3", "shadow-sm");
                                                        let carouselId = `carCarousel_${index}`;
                                            
                                                        let carouselHtml = `
                                                            <div id="${carouselId}" class="carousel slide" data-bs-ride="carousel">
                                                                <div class="carousel-inner">
                                                                    ${car.images.map((img, idx) => `
                                                                        <div class="carousel-item ${idx === 0 ? 'active' : ''}">
                                                                            <img src="${img}" class="d-block w-100 rounded" alt="Car Image">
                                                                        </div>
                                                                    `).join('')}
                                                                </div>
                                                                <button class="carousel-control-prev" type="button" data-bs-target="#${carouselId}" data-bs-slide="prev">
                                                                    <span class="carousel-control-prev-icon"></span>
                                                                </button>
                                                                <button class="carousel-control-next" type="button" data-bs-target="#${carouselId}" data-bs-slide="next">
                                                                    <span class="carousel-control-next-icon"></span>
                                                                </button>
                                                            </div>
                                                        `;
                                            
                                                        carItem.innerHTML = `
                                                            <div class="card-header d-flex justify-content-between">
                                                                <h6 class="mb-0">${car.car_name}</h6>
                                                                <button class="btn btn-sm btn-light" data-bs-toggle="collapse" data-bs-target="#carDetails_${index}">
                                                                    <i class="fas fa-chevron-down"></i>
                                                                </button>
                                                            </div>
                                                            <div id="carDetails_${index}" class="collapse show">
                                                                <div class="card-body">
                                                                    ${carouselHtml}
                                                                    <p><strong>Reg No:</strong> ${car.registration_no}</p>
                                                                    <p><strong>Updated:</strong> ${car.updated_at}</p>
                                                                    <p><strong>Price:</strong> ${car.demand_price}</p>
                                                                    <p><strong>Status:</strong> <span class="badge ${getBadgeClass(car.status)}">${car.status}</span></p>
                                                                    <a href="/dealer/car_detail/${car.car_id}" class="btn btn-primary btn-sm w-100">View</a>
                                                                </div>
                                                            </div>
                                                        `;
                                                        document.getElementById("userCarList").appendChild(carItem);
                                                    });
                                                } else {
                                                    document.getElementById("userCarList").innerHTML = "<p class='text-muted'>No interested cars found.</p>";
                                                }
                                            
                                                // Load previous notes if available
                                                loadNotes(data.id);
                                            
                                                // Show the side panel
                                                var userPanel = new bootstrap.Offcanvas(document.getElementById("userDetailsPanel"));
                                                userPanel.show();
                                            }
                                            /*function openUserPanel(leadData) {
                                                let userDetailsPanel = document.getElementById("userDetailsPanel");
                                                
                                                if (!userDetailsPanel) {
                                                    console.error("userDetailsPanel not found here");
                                                    return;
                                                }
                                            
                                                if (!leadData || !leadData.id) {
                                                    console.error("Lead Data is missing or invalid: ", leadData);
                                                    return;
                                                }
                                            
                                                userDetailsPanel.dataset.leadId = leadData.id;
                                                console.log("Lead Data set:", leadData);
                                            
                                                // Check and set Lead ID Display
                                                let leadIdDisplay = document.getElementById("leadIdDisplay");
                                                if (leadIdDisplay) {
                                                    leadIdDisplay.textContent = leadData.id;
                                                } else {
                                                    console.error("leadIdDisplay element not found!");
                                                }
                                            
                                                // Check and set Sales Notes
                                                let salesNotes = document.getElementById("salesNotes");
                                                if (salesNotes) {
                                                    salesNotes.value = "";  // Clear previous notes
                                                } else {
                                                    console.error("salesNotes element not found!");
                                                }
                                            
                                                // Check and populate interested cars
                                                let carListContainer = document.getElementById("userCarList");
                                                if (!carListContainer) {
                                                    console.error("userCarList element not found!");
                                                    return;
                                                }
                                                carListContainer.innerHTML = ""; // Clear previous cars
                                            
                                                if (leadData.interestedCars && leadData.interestedCars.length > 0) {
                                                    leadData.interestedCars.forEach((car, index) => {
                                                        let carItem = document.createElement("div");
                                                        carItem.classList.add("card", "mb-3", "shadow-sm");
                                            
                                                        let carouselId = `carCarousel_${index}`;
                                                        let carouselHtml = `
                                                            <div id="${carouselId}" class="carousel slide" data-bs-ride="carousel">
                                                                <div class="carousel-inner">
                                                                    ${car.images.map((img, idx) => `
                                                                        <div class="carousel-item ${idx === 0 ? 'active' : ''}">
                                                                            <img src="${img}" class="d-block w-100 rounded" alt="Car Image">
                                                                        </div>
                                                                    `).join('')}
                                                                </div>
                                                                <button class="carousel-control-prev" type="button" data-bs-target="#${carouselId}" data-bs-slide="prev">
                                                                    <span class="carousel-control-prev-icon"></span>
                                                                </button>
                                                                <button class="carousel-control-next" type="button" data-bs-target="#${carouselId}" data-bs-slide="next">
                                                                    <span class="carousel-control-next-icon"></span>
                                                                </button>
                                                            </div>
                                                        `;
                                            
                                                        carItem.innerHTML = `
                                                            <div class="card-header d-flex justify-content-between">
                                                                <h6 class="mb-0">${car.car_name}</h6>
                                                                <button class="btn btn-sm btn-light" data-bs-toggle="collapse" data-bs-target="#carDetails_${index}">
                                                                    <i class="fas fa-chevron-down"></i>
                                                                </button>
                                                            </div>
                                                            <div id="carDetails_${index}" class="collapse show">
                                                                <div class="card-body">
                                                                    ${carouselHtml}
                                                                    <p><strong>Reg No:</strong> ${car.registration_no}</p>
                                                                    <p><strong>Updated:</strong> ${car.updated_at}</p>
                                                                    <p><strong>Price:</strong> ${car.demand_price}</p>
                                                                    <p><strong>Status:</strong> <span class="badge ${getBadgeClass(car.status)}">${car.status}</span></p>
                                                                    <a href="/dealer/car_detail/${car.car_id}" class="btn btn-primary btn-sm w-100">View</a>
                                                                </div>
                                                            </div>
                                                        `;
                                                        carListContainer.appendChild(carItem);
                                                    });
                                                } else {
                                                    carListContainer.innerHTML = "<p class='text-muted'>No interested cars found.</p>";
                                                }
                                            
                                                //loadNotes(leadData.id);
                                            
                                                let userPanel = new bootstrap.Offcanvas(userDetailsPanel);
                                                userPanel.show();
                                            }*/
                                            
                                            
                                               
                                            
                                            function getBadgeClass(status) {
                                                switch (status) {
                                                    case "live": return "badge-soft-success";
                                                    case "expired": return "badge-soft-danger";
                                                    case "sold": return "badge-soft-warning";
                                                    default: return "badge-soft-secondary";
                                                }
                                            }
    
                                            
                                            
                                            
                                            
    
                                        });
    
                                        document.addEventListener("DOMContentLoaded", function () {
                                            function saveNotes() {
                                                const noteText = document.getElementById('salesNotes').value;
                                                if (noteText.trim() === '') return;
                                        
                                                const noteItem = document.createElement('div');
                                                noteItem.classList.add('note-item');
                                                noteItem.innerHTML = `
                                                    <p>${noteText}</p>
                                                    <small class="note-meta">Added on: ${new Date().toLocaleDateString()}</small>
                                                `;


                                        
                                                document.getElementById('notesContainer').prepend(noteItem);
                                                document.getElementById('salesNotes').value = '';
                                            }
                                            
                                        
                                            function loadNotes() {
                                                let userDetailsPanel = document.getElementById("userDetailsPanel");
                                            
                                                if (!userDetailsPanel) {
                                                    console.error("❌ userDetailsPanel not found!");
                                                    return;
                                                }
                                            
                                                let leadId = userDetailsPanel.dataset.leadId;
                                                console.log("📌 Lead ID found:", leadId);  // Debugging
                                            
                                                if (leadId) {
                                                    let savedNotes = localStorage.getItem(`leadNotes_${leadId}`);
                                                    document.getElementById("salesNotes").value = savedNotes ? savedNotes : "";
                                                } else {
                                                    console.error("❌ Lead ID is missing in dataset!");
                                                }
                                            }
                                            
                                        
                                            // Make functions available globally
                                            window.saveNotes = saveNotes;
                                            window.loadNotes = loadNotes;
                                        
                                            // Load notes automatically when the page loads
                                            //loadNotes();
                                        });
    
                                     </script>
                                </div>
                            </div>
                        </div>
                </div>
        </div>
        <!-- end row -->
    </div>
    <!-- container-fluid -->
</div>
</div>
{% endblock %}

{% block js%}
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>

<script>
    function getNotes(lead_id, note_type, note_id, notes) {
        //console.log('Hit the getNotes');
        let csrf_token = getCSRFToken()
        $.ajax({
            url: "{% url 'dealer:lead_notes' %}",
            type: "POST",
            dataType: "json",
            data: {
                lead_id: lead_id,
                note_id: note_id,
                notes: notes,
                note_type: note_type,
            },
            headers: { "X-CSRFToken": csrf_token }, 
            success: function (data) {
                notesArray = JSON.parse(data.datas); 
                $("#notesContainer").empty();
                $.each(notesArray, function (index, note) {
                    //console.log('note: ', note.pk)
                    const noteText = note.fields.notes; 
                    const createdAt = formatDateToIST(note.fields.created_at); 
                    const noteId = note.pk
                    const noteItem = document.createElement('div');
                    noteItem.classList.add('note-item');
                    noteItem.innerHTML = `
                    <div>
                        <div class="notes_action_icons">
                            <a id="edit_note" data-note-id=${noteId} style="cursor: pointer;">Edit</a>
                            <a id="delete_note" data-note-id=${noteId} style="cursor: pointer;">Delete</a>
                        </div>
                        <p>${noteText}</p>
                        <small class="note-meta">Created at: ${createdAt}</small>
                    </div>
                    `;

            
                    document.getElementById('notesContainer').append(noteItem);
                });
                //console.log('noteArray: ', notesArray)
            },            
        });
    }

    $(document).on('click', '#edit_note', function() {
        let note_element = $(this);
        let noteId = note_element.data('note-id'); 
        //console.log('noteId edit_delete: ', noteId);
        const note = notesArray.find(n => n.pk === noteId)
        if(note){
            $('.offcanvas-body').animate({ scrollTop: 0 }, 400);
            $('#salesNotes').val(note.fields.notes);
            $('#save_notes').css('display', 'none')
            $('#edit_notes').css('display', 'block').on('click', function(){
                const notes_content = $('#salesNotes').val();
                //console.log('notes_content -->', notes_content)
                getNotes(current_lead_id, "edit-note", noteId, notes_content)
                $(this).css('display', 'none')
                $('#save_notes').css('display', 'block')
                $('#salesNotes').val('')
            })
        }
    })

    $(document).on('click', '#delete_note', function() {
        $('.offcanvas-body').animate({ scrollTop: 0 }, 400);
        let note_element = $(this);
        let noteId = note_element.data('note-id'); 
        getNotes(current_lead_id, 'delete-note', noteId, null)
    })
       
    function formatDateToIST(utcDate) {
        let date = new Date(utcDate);
        let istDate = new Intl.DateTimeFormat('en-IN', {
            timeZone: 'Asia/Kolkata',
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        }).format(date);
        
        return istDate.replace(',', ' -'); 
    }
    
    function getCSRFToken() {
        let name = "csrftoken=";
        let decodedCookie = decodeURIComponent(document.cookie);
        let cookies = decodedCookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            let c = cookies[i].trim();
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }

    
    function save_notes() {
        console.log('current_lead_id: ', current_lead_id);
        const noteText = document.getElementById('salesNotes').value;
        getNotes(current_lead_id, "new-note", null, noteText);
        console.log('After getNotes')
        document.getElementById('salesNotes').value = '';
    }
    

    function selectCar(carName) {
        document.getElementById('carFilter').value = carName;
        document.getElementById('dropdownMenuButton').textContent = carName === 'all' ? 'All Cars' : carName;
        filterTable(); // Call the function to filter the table
    }
    
</script>

<script>
    // Function to search in the currently active tab's table
    function searchTable() {
        const input = document.getElementById("searchInput").value.toUpperCase();
        const activeTabContent = document.querySelector(".tab-pane.show.active"); // Find the active tab's content
        const table = activeTabContent.querySelector("table"); // Get the table in the active tab
        const tr = table.getElementsByTagName("tr");

        for (let i = 1; i < tr.length; i++) {
            const tds = tr[i].getElementsByTagName("td");
            let matchFound = false;

            for (let j = 0; j < tds.length; j++) {
                const td = tds[j];
                const txtValue = td.textContent || td.innerText;

                if (txtValue.toUpperCase().indexOf(input) > -1) {
                    matchFound = true;
                    const regex = new RegExp(`(${input})`, "gi");
                    td.innerHTML = txtValue.replace(regex, "<span class='highlight'>$1</span>"); // Highlight matches
                } else {
                    td.innerHTML = txtValue; // Reset the cell content if no match
                }
            }

            tr[i].style.display = matchFound ? "" : "none"; // Show or hide rows based on the search
        }
    }
</script>
<script>
    function filterTable() {
        const dropdown = document.getElementById("carFilter");
        const selectedCar = dropdown.value;
        
        // Trigger form submission or page reload with the selected car
        window.location.href = window.location.pathname + "?car_name=" + selectedCar;
        
        // Reset the dropdown to default after the search
        dropdown.value = "all";
    }

    // On page load, check if a car was selected in the previous search
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const carName = urlParams.get('car_name');
        if (!carName || carName === 'all') {
            document.getElementById('carFilter').value = 'all';  // Reset the dropdown to default
        }
    };
</script>


{% endblock %}